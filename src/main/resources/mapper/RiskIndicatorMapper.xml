<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gang.lu.riskmanagementproject.mapper.RiskIndicatorMapper">

    <!-- 继承公共映射 -->
    <resultMap id="BaseResultMap" type="gang.lu.riskmanagementproject.domain.po.RiskIndicator"
               extends="gang.lu.riskmanagementproject.mapper.WorkerMapper.BasePOResultMap">
        <result column="worker_id" property="workerId"/>
        <result column="heart_rate" property="heartRate"/>
        <result column="respiratory_rate" property="respiratoryRate"/>
        <result column="fatigue_percent" property="fatiguePercent"/>
        <result column="risk_level" property="riskLevel"/>
        <result column="alert_flag" property="alertFlag"/>
    </resultMap>


    <select id="selectLatestByWorkerId" resultMap="BaseResultMap"
            parameterType="java.lang.Long">
        SELECT *
        FROM t_risk_indicator
        WHERE worker_id = #{workerId}
        ORDER BY create_time DESC
        LIMIT 1
    </select>


    <select id="countDistinctWorkerByRiskLevel" resultType="java.util.Map">
        SELECT risk_level, COUNT(DISTINCT worker_id) AS count
        FROM t_risk_indicator
        GROUP BY risk_level
    </select>

    <select id="countHighRiskWorkerByTimePeriod" resultType="java.util.Map">
        SELECT
            t.period,
            IFNULL(c.count, 0) AS count
        FROM (
                 -- 生成6个固定时间段
                 SELECT 0 AS period UNION ALL
                 SELECT 4 AS period UNION ALL
                 SELECT 8 AS period UNION ALL
                 SELECT 12 AS period UNION ALL
                 SELECT 16 AS period UNION ALL
                 SELECT 20 AS period
             ) t
                 LEFT JOIN (
            -- 原统计逻辑
            SELECT
                FLOOR(HOUR(create_time) / 4) * 4 AS period,
                COUNT(DISTINCT worker_id) AS count
            FROM t_risk_indicator
            WHERE DATE(create_time) = #{statDate} AND risk_level != '低风险'
            GROUP BY period
        ) c ON t.period = c.period
    </select>

</mapper>
